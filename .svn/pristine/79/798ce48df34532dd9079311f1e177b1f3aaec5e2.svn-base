package com.efun.mainland.util.cache;

import java.util.Map.Entry;
import java.util.Set;
import java.util.Timer;
import java.util.TimerTask;
import java.util.concurrent.ConcurrentHashMap;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("rawtypes")
public final class CacheEntityUtil {
	private final static Logger logger = LoggerFactory.getLogger(CacheEntityUtil.class);
	private final static Timer timer = new Timer();
	private final static int time = 5 * 60 * 1000;
	private final static ConcurrentHashMap<String, CacheEntity> map = new ConcurrentHashMap<String, CacheEntity>();

	static {
		try {
			timer.scheduleAtFixedRate(new TimerTask() {
				public void run() {
					try {
						long startTime = System.currentTimeMillis();
						Set<Entry<String, CacheEntity>> set = map.entrySet();
						int before = map.size();
						for (Entry<String, CacheEntity> keyValue : set) {
							CacheEntity temp = keyValue.getValue();
							if (temp == null || temp.ttl() <= 0L) {
								map.remove(keyValue.getKey());
								logger.debug("timeout:key={}", keyValue.getKey());
							}
						}
						int after = map.size();
						logger.debug("cache size:before={},after={},time={}milliseconds", before, after,
								(System.currentTimeMillis() - startTime));
					} catch (Throwable e) {
					}
				}
			}, 1000 * 60, time);
		} catch (Throwable e) {
		}
	}

	public static boolean containsKey(String key) {
		if (key != null) {
			return map.containsKey(key);
		} else {
			return false;
		}
	}

	public static <T> void setCache(String key, CacheEntity<T> cacheEntity) {
		if (cacheEntity != null && key != null) {
			map.put(key, cacheEntity);
			logger.debug("set cache:key={},ttl={}milliseconds", key, cacheEntity.ttl());
		}
	}

	public static void deleteCache(String key) {
		if (key != null) {
			map.remove(key);
			logger.debug("delete cache:key={}", key);
		}
	}

	@SuppressWarnings("unchecked")
	public static <T> CacheEntity<T> getCache(String key) {
		CacheEntity cacheEntity = null;
		if (key != null) {
			cacheEntity = map.get(key);
			if (cacheEntity != null) {
				long ttl = cacheEntity.ttl();
				if (cacheEntity.ttl() <= 0L) {
					map.remove(key);
					cacheEntity = null;
					logger.debug("timeout:key={}", key);
				} else {
					logger.debug("get cache success:key={},ttl={}milliseconds", key, ttl);
				}
			}
		}
		return ((CacheEntity<T>) cacheEntity);
	}
}
