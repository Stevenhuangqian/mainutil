package com.efun.mainland.util;

import java.beans.PropertyDescriptor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Set;
import java.util.Map.Entry;

import org.apache.commons.lang3.StringUtils;

public class SqlUtil {
	
	private static SimpleDateFormat getSimpleDateFormat(){
		return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
	}

	/**
	 * 获取select语句
	 * <p>
	 * 单表
	 * 
	 * @param obj
	 *            实体对象
	 * @param tableName
	 *            表名（为空时，表名为实体类类名）
	 * @param selectFields
	 *            查询字段（select和from之间的部分，为空时，值为 * ）
	 * @param otherConditions
	 *            其他约束条件
	 * @return obj[0]为sql语句,obj[1]为条件值（Object[]）
	 */
	public static Object[] getSelectSql(Object obj, String tableName,
			String selectFields, String... otherConditions) {
		HashMap<String, String> aliasTableMap = new HashMap<String, String>(1);
		HashMap<String, Object> aliasEntityMap = new HashMap<String, Object>(1);
		if (CommonUtil.objectIsNull(tableName)) {
			if (CommonUtil.objectIsNull(obj)) {
				return null;
			} else {
				tableName = obj.getClass().getSimpleName();
			}
		}
		aliasTableMap.put("t", tableName);
		aliasEntityMap.put("t", obj);
		return getSelectSql(aliasTableMap, aliasEntityMap, selectFields,
				otherConditions);
	}

	/**
	 * /** 获取update语句
	 * <p>
	 * 
	 * @param obj
	 *            实体对象
	 * @param tableName
	 *            表名（为空时，表名为实体类类名）
	 * @param fieldValueMap
	 *            条件（key为字段名，value为字段值）
	 * @return obj[0]为sql语句,obj[1]为条件值（Object[]）
	 */
	public static Object[] getUpdateSql(Object obj, String tableName,
			HashMap<String, String> fieldValueMap) {
		if (CommonUtil.objectIsNull(obj)) {
			return null;
		} else {
			StringBuilder strBuilder = new StringBuilder();
			strBuilder.append("UPDATE ");
			if (CommonUtil.objectIsNull(tableName)) {
				strBuilder.append(obj.getClass().getSimpleName());
			} else {
				strBuilder.append(tableName);
			}
			strBuilder.append(" SET ");

			StringBuilder sb = new StringBuilder();
			List<Object> list = new ArrayList<Object>();
			PropertyDescriptor proper = null;
			Field[] fields = obj.getClass().getDeclaredFields();
			for (Field field : fields) {
				try {
					proper = new PropertyDescriptor(field.getName(), obj
							.getClass());
					Method method = proper.getReadMethod();

					Object objOne = method.invoke(obj);
					if (objOne != null) {
						sb.append(",").append(field.getName()).append("=?");
						if (StringUtils.containsIgnoreCase(method
								.getReturnType()
								+ "", "date")) {
							list.add(getSimpleDateFormat().format((Date) objOne));
						} else {
							list.add(objOne);
						}
					}
				} catch (Exception e) {
					continue;
				}
			}
			strBuilder.append(sb.substring(1));

			if (fieldValueMap != null && fieldValueMap.size() > 0) {
				strBuilder.append(" WHERE ");
				StringBuilder sbapend = new StringBuilder();
				Set<Entry<String, String>> tempSet = fieldValueMap.entrySet();
				int i = 0;
				for (Entry<String, String> keyValue : tempSet) {
					if (i == 0) {
						sbapend.append(keyValue.getKey()).append("=?");
					} else {
						sbapend.append(" AND ").append(keyValue.getKey())
								.append("=?");
					}
					list.add(keyValue.getValue());
					i++;
				}
				strBuilder.append(sbapend.toString());
			}
			return new Object[] { strBuilder.toString(), list.toArray() };
		}
	}

	/**
	 * 获取insert语句
	 * <p>
	 * 
	 * @param obj
	 *            实体对象
	 * @param tableName
	 *            表名（为空时，表名为实体类类名）
	 * @return obj[0]为sql语句,obj[1]为条件值（Object[]）
	 */
	public static Object[] getInsertSql(Object obj, String tableName) {
		if (CommonUtil.objectIsNull(obj)) {
			return null;
		} else {
			StringBuilder strBuilder = new StringBuilder();
			strBuilder.append("INSERT INTO ");
			if (CommonUtil.objectIsNull(tableName)) {
				strBuilder.append(obj.getClass().getSimpleName());
			} else {
				strBuilder.append(tableName);
			}
			strBuilder.append("(");

			StringBuilder sb = new StringBuilder();
			StringBuilder sbapend = new StringBuilder();
			List<Object> list = new ArrayList<Object>();
			PropertyDescriptor proper = null;
			Field[] fields = obj.getClass().getDeclaredFields();
			for (Field field : fields) {
				try {
					proper = new PropertyDescriptor(field.getName(), obj
							.getClass());
					Method method = proper.getReadMethod();

					Object objOne = method.invoke(obj);
					if (objOne != null) {
						sb.append(",").append(field.getName());
						sbapend.append(",?");
						if (StringUtils.containsIgnoreCase(method
								.getReturnType()
								+ "", "date")) {
							list.add(getSimpleDateFormat().format((Date) objOne));
						} else {
							list.add(objOne);
						}
					}
				} catch (Exception e) {
					continue;
				}
			}
			strBuilder.append(sb.substring(1));

			strBuilder.append(") VALUES (");
			strBuilder.append(sbapend.substring(1)).append(")");
			return new Object[] { strBuilder.toString(), list.toArray() };
		}
	}

	/**
	 * 获取select语句
	 * <p>
	 * 多表
	 * 
	 * @param aliasTableMap
	 *            key值为表别名，value值为表名
	 * @param aliasEntityMap
	 *            key值为表别名，value值为实体对象
	 * @param selectFields
	 *            查询字段（select和from之间的部分，为空时，值为所有表的所有字段 ）
	 * @param otherConditions
	 *            其他约束条件
	 * @return obj[0]为sql语句,obj[1]为条件值（Object[]）
	 */
	public static Object[] getSelectSql(HashMap<String, String> aliasTableMap,
			HashMap<String, Object> aliasEntityMap, String selectFields,
			String... otherConditions) {
		try {
			ArrayList<Object> valuesList = new ArrayList<Object>();
			StringBuilder strBuilder = new StringBuilder();
			if (aliasTableMap == null || aliasTableMap.size() == 0) {
				if (aliasEntityMap == null || aliasEntityMap.size() == 0) {
					return null;
				} else {
					Set<Entry<String, Object>> tempSet = aliasEntityMap
							.entrySet();
					int tableSize = aliasEntityMap.size();
					if (CommonUtil.objectIsNull(selectFields)) {
						if (tableSize == 1) {
							strBuilder.append("SELECT * FROM ").append(
									aliasEntityMap.values().toArray()[0]
											.getClass().getSimpleName());
						} else {
							strBuilder.append("SELECT ");
							int i = 0;
							for (Entry<String, Object> entry : tempSet) {
								if (i == 0) {
									strBuilder.append(entry.getKey()).append(
											".*");
								} else {
									strBuilder.append(",").append(
											entry.getKey()).append(".*");
								}
								i++;
							}
							strBuilder.append(" FROM ");
							i = 0;
							for (Entry<String, Object> entry : tempSet) {
								if (i == 0) {
									strBuilder.append(
											entry.getValue().getClass()
													.getSimpleName()).append(
											" ").append(entry.getKey());
								} else {
									strBuilder.append(",").append(
											entry.getValue().getClass()
													.getSimpleName()).append(
											" ").append(entry.getKey());
								}
								i++;
							}
						}
					} else {
						strBuilder.append("SELECT ").append(selectFields)
								.append(" FROM ");
						if (tableSize == 1) {
							strBuilder
									.append(aliasEntityMap.values().toArray()[0]
											.getClass().getSimpleName());
						} else {
							int i = 0;
							for (Entry<String, Object> entry : tempSet) {
								if (i == 0) {
									strBuilder.append(
											entry.getValue().getClass()
													.getSimpleName()).append(
											" ").append(entry.getKey());
								} else {
									strBuilder.append(",").append(
											entry.getValue().getClass()
													.getSimpleName()).append(
											" ").append(entry.getKey());
								}
								i++;
							}
						}
					}
					strBuilder.append(" WHERE 1=1");
					if (tableSize == 1) {
						Object obj = aliasEntityMap.values().toArray()[0];
						if (obj != null) {
							Method[] sourceMethods = obj.getClass()
									.getMethods();
							for (int i = 0, len = sourceMethods.length; i < len; i++) {
								if (sourceMethods[i].getName()
										.startsWith("get")) {
									if (sourceMethods[i].getName().equals(
											"getClass")) {
										continue;
									}
									Object loValue = sourceMethods[i]
											.invoke(obj);
									if (CommonUtil.objectIsNotNull(loValue)) {
										strBuilder
												.append(" AND ")
												.append(
														CommonUtil
																.getFieldName(sourceMethods[i]
																		.getName()))
												.append("=?");
										valuesList.add(loValue);
									}
								}
							}
						}
					} else {
						for (Entry<String, Object> entry : tempSet) {
							Object obj = entry.getValue();
							if (obj != null) {
								Method[] sourceMethods = obj.getClass()
										.getMethods();
								for (int i = 0, len = sourceMethods.length; i < len; i++) {
									if (sourceMethods[i].getName().startsWith(
											"get")) {
										if (sourceMethods[i].getName().equals(
												"getClass")) {
											continue;
										}
										Object loValue = sourceMethods[i]
												.invoke(obj);
										if (CommonUtil.objectIsNotNull(loValue)) {
											strBuilder
													.append(" AND ")
													.append(entry.getKey())
													.append(".")
													.append(
															CommonUtil
																	.getFieldName(sourceMethods[i]
																			.getName()))
													.append("=?");
											valuesList.add(loValue);
										}
									}
								}
							}
						}
					}
					if (CommonUtil.objectIsNotNull(otherConditions)) {
						for (String otherCondition : otherConditions) {
							if (CommonUtil.objectIsNotNull(otherCondition)) {
								strBuilder.append(" AND ").append(
										otherCondition);
							}
						}
					}
					return new Object[] { strBuilder.toString(), valuesList };
				}

			} else {
				Set<Entry<String, String>> tempSet = aliasTableMap.entrySet();
				if (aliasEntityMap == null || aliasEntityMap.size() == 0) {
					int tableSize = aliasTableMap.size();
					if (CommonUtil.objectIsNull(selectFields)) {
						if (tableSize == 1) {
							strBuilder.append("SELECT * FROM ").append(
									aliasTableMap.values().toArray()[0]);
						} else {
							strBuilder.append("SELECT ");
							int i = 0;
							for (Entry<String, String> entry : tempSet) {
								if (i == 0) {
									strBuilder.append(entry.getKey()).append(
											".*");
								} else {
									strBuilder.append(",").append(
											entry.getKey()).append(".*");
								}
								i++;
							}
							strBuilder.append(" FROM ");
							i = 0;
							for (Entry<String, String> entry : tempSet) {
								if (i == 0) {
									strBuilder.append(entry.getValue()).append(
											" ").append(entry.getKey());
								} else {
									strBuilder.append(",").append(
											entry.getValue()).append(" ")
											.append(entry.getKey());
								}
								i++;
							}
						}
					} else {
						strBuilder.append("SELECT ").append(selectFields)
								.append(" FROM ");
						if (tableSize == 1) {
							strBuilder
									.append(aliasTableMap.values().toArray()[0]);
						} else {
							int i = 0;
							for (Entry<String, String> entry : tempSet) {
								if (i == 0) {
									strBuilder.append(entry.getValue()).append(
											" ").append(entry.getKey());
								} else {
									strBuilder.append(",").append(
											entry.getValue()).append(" ")
											.append(entry.getKey());
								}
								i++;
							}
						}
					}
					strBuilder.append(" WHERE 1=1");
					if (CommonUtil.objectIsNotNull(otherConditions)) {
						for (String otherCondition : otherConditions) {
							if (CommonUtil.objectIsNotNull(otherCondition)) {
								strBuilder.append(" AND ").append(
										otherCondition);
							}
						}
					}
					return new Object[] { strBuilder.toString(), valuesList };
				} else {
					ArrayList<String> aliasList = new ArrayList<String>();
					for (String key : aliasTableMap.keySet()) {
						aliasList.add(key);
					}
					for (String key : aliasEntityMap.keySet()) {
						if (!aliasList.contains(key)) {
							aliasList.add(key);
						}
					}
					int tableSize = aliasList.size();
					if (CommonUtil.objectIsNull(selectFields)) {
						if (tableSize == 1) {
							strBuilder.append("SELECT * FROM ");
							if (CommonUtil.objectIsNotNull(aliasTableMap
									.values().toArray()[0])) {
								strBuilder.append(aliasTableMap.values()
										.toArray()[0]);
							} else {
								strBuilder.append(aliasEntityMap.values()
										.toArray()[0].getClass()
										.getSimpleName());
							}
						} else {
							strBuilder.append("SELECT ");
							int i = 0;
							for (String key : aliasList) {
								if (i == 0) {
									strBuilder.append(key).append(".*");
								} else {
									strBuilder.append(",").append(key).append(
											".*");
								}
								i++;
							}
							strBuilder.append(" FROM ");
							i = 0;
							for (String key : aliasList) {
								if (i != 0) {
									strBuilder.append(",");
								}
								if (aliasTableMap.get(key) != null) {
									strBuilder.append(aliasTableMap.get(key));
								} else {
									strBuilder.append(aliasEntityMap.get(key)
											.getClass().getSimpleName());
								}
								strBuilder.append(" ").append(key);
								i++;
							}
						}
					} else {
						strBuilder.append("SELECT ").append(selectFields)
								.append(" FROM ");
						if (tableSize == 1) {
							if (CommonUtil.objectIsNotNull(aliasTableMap
									.values().toArray()[0])) {
								strBuilder.append(aliasTableMap.values()
										.toArray()[0]);
							} else {
								strBuilder.append(aliasEntityMap.values()
										.toArray()[0].getClass()
										.getSimpleName());
							}
						} else {
							int i = 0;
							for (String key : aliasList) {
								if (i != 0) {
									strBuilder.append(",");
								}
								if (aliasTableMap.get(key) != null) {
									strBuilder.append(aliasTableMap.get(key));
								} else {
									strBuilder.append(aliasEntityMap.get(key)
											.getClass().getSimpleName());
								}
								strBuilder.append(" ").append(key);
								i++;
							}
						}
					}
					strBuilder.append(" WHERE 1=1");
					if (tableSize == 1) {
						Object obj = aliasEntityMap.values().toArray()[0];
						if (obj != null) {
							Method[] sourceMethods = obj.getClass()
									.getMethods();
							for (int i = 0, len = sourceMethods.length; i < len; i++) {
								if (sourceMethods[i].getName()
										.startsWith("get")) {
									if (sourceMethods[i].getName().equals(
											"getClass")) {
										continue;
									}
									Object loValue = sourceMethods[i]
											.invoke(obj);
									if (CommonUtil.objectIsNotNull(loValue)) {
										strBuilder
												.append(" AND ")
												.append(
														CommonUtil
																.getFieldName(sourceMethods[i]
																		.getName()))
												.append("=?");
										valuesList.add(loValue);
									}
								}
							}
						}
					} else {
						for (Entry<String, Object> entry : aliasEntityMap
								.entrySet()) {
							Object obj = entry.getValue();
							if (obj != null) {
								Method[] sourceMethods = obj.getClass()
										.getMethods();
								for (int i = 0, len = sourceMethods.length; i < len; i++) {
									if (sourceMethods[i].getName().startsWith(
											"get")) {
										if (sourceMethods[i].getName().equals(
												"getClass")) {
											continue;
										}
										Object loValue = sourceMethods[i]
												.invoke(obj);
										if (CommonUtil.objectIsNotNull(loValue)) {
											strBuilder
													.append(" AND ")
													.append(entry.getKey())
													.append(".")
													.append(
															CommonUtil
																	.getFieldName(sourceMethods[i]
																			.getName()))
													.append("=?");
											valuesList.add(loValue);
										}
									}
								}
							}
						}
					}
					if (CommonUtil.objectIsNotNull(otherConditions)) {
						for (String otherCondition : otherConditions) {
							if (CommonUtil.objectIsNotNull(otherCondition)) {
								strBuilder.append(" AND ").append(
										otherCondition);
							}
						}
					}
					return new Object[] { strBuilder.toString(), valuesList.toArray() };
				}
			}
		} catch (SecurityException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IllegalArgumentException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (InvocationTargetException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return null;
	}
}
